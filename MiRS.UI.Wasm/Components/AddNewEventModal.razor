@if (IsVisible)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onmousedown="CloseModal">
        <div class="modal-dialog modal-dialog-centered d-flex justify-content-center  modal-lg" @onmousedown:stopPropagation="true">
            <div class="modal-content texture-effect-grain" style="min-height:40vh;">
                <div class="modal-header" style="border-color:#c6aa76;">
                    <h2 class="fs-3 event-card-title mx-auto mb-2 runescape-font ps-4">
                        Create New Event
                    </h2>
                    <button type="button" class="btn-close" aria-label="Close" @onmousedown="CloseModal"></button>
                </div>
                <EditForm Model="ViewModel" OnValidSubmit="SaveEventForm">
                <DataAnnotationsValidator />
                    <div class="modal-body">

                        <div class="row mb-2 align-items-center">
                            <label class="col-4 col-form-label text-white runescape-font fw-bold">
                                Event Name
                            </label>
                            <div class="col-8">
                                <input type="text" class="modal-textbox"
                                       @bind="ViewModel.Eventname"
                                       @bind:event="oninput" />
                            </div>
                            <ValidationMessage For="@(() => ViewModel.Eventname)" class="text-danger small d-block text-end mt-1" />

                        </div>
                        <div class="row mb-2 align-items-center">
                            <label class="col-4 col-form-label text-white runescape-font fw-bold">
                                Discord Server ID
                                <span class="info-tooltip-container">
                                    <i class="fas fa-info-circle info-icon"></i>
                                    <span class="tooltip-text">This is for the discord helper bot to link your event to your discord server</span>
                                </span>
                            </label>
                            <div class="col-8">
                                <input type="text" class="modal-textbox"
                                       @bind="ViewModel.GuildId"
                                       @bind:event="oninput" />
                            </div>
                            <ValidationMessage For="@(() => ViewModel.GuildId)" class="text-danger small d-block text-end mt-1" />

                        </div>
                        <div class="row mb-2 align-items-center">
                            <label class="col-4 col-form-label text-white runescape-font fw-bold">
                                Participant Password
                                <span class="info-tooltip-container">
                                    <i class="fas fa-info-circle info-icon"></i>
                                    <span class="tooltip-text">This is the optional password for users to place in 'Clan Events' plugin</span>
                                </span>
                            </label>
                            <div class="col-8">
                                <input type="text" class="modal-textbox"
                                       @bind="ViewModel.ParticipantPassword"
                                       @bind:event="oninput" />
                            </div>
                        </div>

                        <div class="row mb-2 align-items-center">
                            <label class="col-4 col-form-label text-white runescape-font fw-bold">
                                Admin Password
                                <span class="info-tooltip-container">
                                    <i class="fas fa-info-circle info-icon"></i>
                                    <span class="tooltip-text">This is to edit your event later! DO NOT FORGET!</span>
                                </span>
                            </label>
                            <div class="col-8">
                                <input type="password" class="modal-textbox"
                                       @bind="ViewModel.EventPassword"
                                       @bind:event="oninput" />
                            </div>
                            <ValidationMessage For="@(() => ViewModel.EventPassword)" class="text-danger small d-block text-end mt-1" />

                        </div>
                        <div class="row mb-2 align-items-center">
                            <label class="col-4 col-form-label text-white runescape-font fw-bold">
                                Event Start
                                <span class="info-tooltip-container">
                                    <i class="fas fa-info-circle info-icon"></i>
                                    <span class="tooltip-text">Date & Time is in UTC (Check OSRS ingame time)</span>
                                </span>
                            </label>
                            <div class="col-8 d-flex gap-2">
                                <InputDate class="modal-datepicker flex-grow-1"
                                           @bind-Value="ViewModel.EventStart"
                                           min="@DateTime.Today.AddDays(1).ToString("yyyy-MM-dd")" />
                                <div style="color: #c6aa76; font-size:large" bold>@@</div>
                                <select class="modal-select w-auto px-4"
                                        @bind="ViewModel.EventStartHour">
                                    @for (int i = 1; i < 13; i++)
                                    {
                                        <option value="@i.ToString()">@i</option>
                                    }
                                </select>
                                <div style="color: #c6aa76; font-size:large" bold>:</div>
                                <select class="modal-select w-auto px-4"
                                        @bind="ViewModel.EventStartMinutes">
                                    <option value="00">00</option>
                                    <option value="30">30</option>
                                </select>
                                <select class="modal-select w-auto px-4"
                                        @bind="ViewModel.EventStartAmPm">
                                    <option value="am">AM</option>
                                    <option value="pm">PM</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mb-2 align-items-center">
                            <label class="col-4 col-form-label text-white runescape-font fw-bold">
                                Event End
                                <span class="info-tooltip-container">
                                    <i class="fas fa-info-circle info-icon"></i>
                                    <span class="tooltip-text">Date & Time is in UTC (Check OSRS ingame time)</span>
                                </span>
                            </label>
                            <div class="col-8 d-flex gap-2">
                                <InputDate class="modal-datepicker flex-grow-1"
                                           @bind-Value="ViewModel.EventEnd"
                                           min="@ViewModel.EventStart.AddDays(1).ToString("yyyy-MM-dd")" />
                                <div style="color: #c6aa76; font-size:large" bold>@@</div>
                                <select class="modal-select w-auto px-4"
                                        @bind="ViewModel.EventEndHour">
                                    @for (int i = 1; i < 13; i++)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                </select>
                                <div style="color: #c6aa76; font-size:large" bold>:</div>                       
                                <select class="modal-select w-auto px-4"
                                        @bind="ViewModel.EventEndMinute">
                                    <option value="00">00</option>
                                    <option value="30">30</option>
                                </select>
                                <select class="modal-select w-auto px-4"
                                        @bind="ViewModel.EventEndAmPm">
                                    <option value="am">AM</option>
                                    <option value="pm">PM</option>
                                </select>
                            </div>
                        </div>
                   
                    </div>
                    <div class="modal-footer m-0 p-0" style="border: none;">
                        <button class="btn btn-primary me-2" type="submit">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}


@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback<bool> IsVisibleChanged { get; set; }
    [Parameter] public EventCallback<AddEventRequest> OnSave { get; set; }

    private AddNewEventViewModal ViewModel = new AddNewEventViewModal();

    private async Task CloseModal()
    {
        await Task.Delay(200, new CancellationTokenSource().Token);
        IsVisible = false;
        ViewModel = new AddNewEventViewModal();
        await IsVisibleChanged.InvokeAsync(false);
    }

    private async Task SaveEventForm()
    {
        TimeOnly eventStartTime = TimeOnly.ParseExact($"{ViewModel.EventStartHour}:{ViewModel.EventStartMinutes} {ViewModel.EventStartAmPm}", "h:mm tt", CultureInfo.InvariantCulture);

        TimeOnly eventEndTime = TimeOnly.ParseExact($"{ViewModel.EventEndHour}:{ViewModel.EventEndMinute} {ViewModel.EventEndAmPm}", "h:mm tt", CultureInfo.InvariantCulture);

        AddEventRequest newEventRequest = new AddEventRequest
        {
            GuildId = ViewModel.GuildId,
            Eventname = ViewModel.Eventname,
            ParticipantPassword = ViewModel.ParticipantPassword,
            EventPassword = ViewModel.EventPassword,
            EventStart = new DateTimeOffset(ViewModel.EventStart, eventStartTime, TimeSpan.Zero),
            EventEnd = new DateTimeOffset(ViewModel.EventEnd, eventEndTime, TimeSpan.Zero)
        };

        await OnSave.InvokeAsync(newEventRequest);

        ViewModel = new AddNewEventViewModal();

        await CloseModal();
    }
}
